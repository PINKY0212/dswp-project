<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hybrid Model | SARIMA + LSTM Residual Correction</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/style.css" />

  <style>
    /* Header Styling */
    .topbar {
      height: 90px;
      overflow: visible;
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border-bottom: 2px solid rgba(0, 120, 255, 0.1);
    }
    .content { padding-top: 112px; }
    .topbar-center {
      font-size: 2em;
      font-weight: 700;
      letter-spacing: 3px;
      color: #0078ff;
      background: linear-gradient(135deg, #0078ff 0%, #3b82f6 50%, #6366f1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      display: inline-block;
      padding: 8px 24px;
      margin: 0 auto;
      text-transform: uppercase;
      transition: all 0.3s ease;
    }
    .topbar-center::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      bottom: 2px;
      height: 3px;
      background: linear-gradient(90deg, transparent, #0078ff, #3b82f6, #0078ff, transparent);
      border-radius: 2px;
      opacity: 0.5;
      animation: shimmer-line 3s ease-in-out infinite;
    }
    @keyframes shimmer-line { 0%,100%{opacity:0.3;} 50%{opacity:0.7;} }
    .icon-btn { z-index: 1002; position: relative; }
    body { background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); }
    html { background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); }
    .header-logo { height: 150px; width: auto; margin-right: 1px; margin-left: -10px; object-fit: contain; }

    /* Dashboard layout */
    .dash{
      display:block;
    }

    /* KPI Grid */
    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-top: 14px;
    }
    @media (max-width: 980px){ .kpi-grid{ grid-template-columns: 1fr; } }
    .kpi{
      border: 2px solid #3b82f6;
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(255,255,255,0.25);
    }
    .kpi .label{ color: var(--text-muted); font-size: 14px; font-weight: 700; }
    .kpi .value{ font-size: 16px; margin-top: 2px; }

    /* Tabs */
    .tabs { display:flex; flex-wrap:wrap; gap:8px; margin: 10px 0 0; justify-content:center; }
    .tab{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border:1px solid var(--border); border-radius: 999px;
      text-decoration:none; color: var(--text-main); background:#fff;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
    }
    .tab:hover{ 
      transform: translateY(-2px); 
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3), 0 4px 12px rgba(59, 130, 246, 0.15);
      border-color: #3b82f6;
    }
    .tab.active{ background: var(--primary); border-color: var(--primary); color:#fff; }

    /* Pills */
    .pill-row{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px; justify-content:center; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border:1px solid var(--border);
      border-radius: 999px;
      background:#fff;
      color: var(--text-main);
      text-decoration:none;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .pill:hover{ 
      transform: translateY(-2px); 
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3), 0 4px 12px rgba(59, 130, 246, 0.15);
      border-color: #3b82f6;
    }
    .pill i{ color: var(--primary); }

    /* Summary box */
    .summary-box{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,0.35);
      padding: 14px;
      margin-top: 14px;
      text-align:left;
    }

    /* Metrics panels */
    .grid-2{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:14px; margin-top: 12px; }
    @media (max-width: 980px){ .grid-2 { grid-template-columns: 1fr; } }
    .panel{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,0.35);
      padding: 14px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.06);
      transition: all 0.3s ease;
    }
    .panel:hover{
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(59, 130, 246, 0.25), 0 6px 16px rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.4);
    }
    .metrics { width:100%; border-collapse: collapse; margin-top: 10px; border:1px solid var(--border); border-radius: 10px; overflow:hidden; background:#fff; }
    .metrics th, .metrics td { padding: 10px 12px; border-bottom:1px solid var(--border); text-align:left; }
    .metrics th { background:#f9fafb; }
    .metrics tr:last-child td { border-bottom:none; }
    .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 10px; }
    @media (max-width: 768px){ .metrics-grid { grid-template-columns: 1fr; } }
    .metrics-col { border:1px solid var(--border); border-radius: 10px; overflow:hidden; background:#fff; }
    .metrics-col-header { padding: 10px 12px; background:#f9fafb; font-weight: 700; border-bottom:1px solid var(--border); }
    .metrics-col table { width:100%; border-collapse: collapse; }
    .metrics-col table td { padding: 8px 12px; border-bottom:1px solid var(--border); }
    .metrics-col table tr:last-child td { border-bottom:none; }
    .directional-accuracy-card {
      margin-top: 12px;
      padding: 10px 12px;
      border: 1px solid #3b82f6;
      border-radius: 8px;
      background: rgba(59, 130, 246, 0.05);
      text-align: center;
    }
    .directional-accuracy-card .label {
      font-size: 0.85em;
      color: var(--text-muted);
      font-weight: 600;
      margin-bottom: 4px;
    }
    .directional-accuracy-card .value {
      font-size: 1.2em;
      font-weight: 700;
      color: #3b82f6;
    }

    /* Plot grid - modern cardplot style */
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-top: 12px;
    }
    .cardplot{
      border: 1px solid #e5e7eb;
      background: #ffffff;
      border-radius: 16px;
      overflow:hidden;
      cursor:pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
      position: relative;
    }
    .cardplot::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(0, 120, 255, 0.02) 0%, rgba(249, 250, 251, 0.5) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 1;
    }
    .cardplot:hover::before {
      opacity: 1;
    }
    .cardplot:hover{
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 12px 32px rgba(0, 120, 255, 0.25), 0 6px 16px rgba(0, 120, 255, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
      border-color: rgba(0, 120, 255, 0.4);
    }
    @media (max-width: 1200px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px){
      .grid{ grid-template-columns: 1fr; }
    }

    .cardplot-head{
      padding: 16px 18px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid #f3f4f6;
      background: linear-gradient(135deg, rgba(0, 120, 255, 0.04) 0%, rgba(249, 250, 251, 0.8) 100%);
      transition: all 0.3s ease;
      position: relative;
      z-index: 2;
      text-align: left;
    }
    .cardplot:hover .cardplot-head{
      background: linear-gradient(135deg, rgba(0, 120, 255, 0.08) 0%, rgba(239, 246, 255, 0.9) 100%);
      border-bottom-color: rgba(0, 120, 255, 0.15);
    }
    .cardplot-title{ 
      font-weight: 600; 
      margin:0; 
      font-size: 20px;
      color: #111827;
      letter-spacing: -0.01em;
      transition: color 0.3s ease;
      text-align: left;
    }
    .cardplot:hover .cardplot-title {
      color: #0078ff;
    }
    .cardplot-sub{ 
      color: #9ca3af; 
      margin-top: 6px; 
      line-height: 1.5; 
      font-size: 14px;
    }

    .cardplot-body{ 
      padding: 12px 14px 14px; 
      position: relative;
      z-index: 2;
    }
    .plot-img{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fff;
      transition: transform 0.3s ease;
    }
    .cardplot:hover .plot-img {
      transform: scale(1.02);
    }

    /* Enable hover on the main Hybrid Model section card */
    section.card:first-of-type {
      transition: all 0.3s ease;
    }
    section.card:first-of-type:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(59, 130, 246, 0.25), 0 6px 16px rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.4);
    }

    /* Modal */
    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal-overlay.open{ display:flex; }
    .modal{
      width:min(1100px, 96vw);
      max-height: 92vh;
      overflow:hidden;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(20,24,32,0.96);
      display:flex;
      flex-direction:column;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.10);
    }
    .modal-title{ opacity:0.95; font-weight: 700; color: #fff; }
    .modal-actions{ display:flex; gap:8px; align-items:center; }
    .icon-round{
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      color: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: background 0.2s ease;
    }
    .icon-round:hover{ background: rgba(255,255,255,0.08); }
    .modal-body{ overflow:auto; padding:14px; }
    .modal-body img{
      width:100%;
      height:auto;
      display:block;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
    }
    .modal-cap{ margin-top:10px; opacity:0.9; color: #9ca3af; }
  </style>
</head>

<body>
<header class="topbar">
  <div class="topbar-left">
    <button class="icon-btn" aria-label="Menu"><i class="bi bi-list"></i></button>
    <img src="../saved_model_outputs/logo.png" alt="EurGrid Logo" class="header-logo">
  </div>
  <div class="topbar-center">EurGrid</div>
</header>

<aside class="sidebar">
  <div class="sidebar-brand">
    Electricity Demand Forecasting
    <div class="brand-sub">Bathula Veera • Gagan • Pinky Sherwani</div>
  </div>

  <nav class="nav">
    <a class="nav-link" href="../ShortTermElectricityDemandForecasting.html"><i class="bi bi-house-door"></i> Home</a>
    <a class="nav-link" href="problem.html"><i class="bi bi-bullseye"></i> Understanding the Problem</a>
    <a class="nav-link" href="dataset.html"><i class="bi bi-database"></i> Dataset</a>
    <a class="nav-link" href="preprocessing.html"><i class="bi bi-sliders"></i> Pre Processing</a>
    <a class="nav-link" href="eda.html"><i class="bi bi-graph-up"></i> Exploratory Data Analysis</a>
    <a class="nav-link" href="features.html"><i class="bi bi-diagram-3"></i> Feature Engineering</a>
    <a class="nav-link active" href="models.html"><i class="bi bi-cpu"></i> Models & Results</a>
    <a class="nav-link" href="explainability.html"><i class="bi bi-lightbulb"></i> Explainability</a>
    <a class="nav-link" href="references.html"><i class="bi bi-book"></i> References</a>

    <div class="nav-divider"></div>
    <a class="nav-link" id="githubLink"><i class="bi bi-github"></i> Git Repository</a>
  </nav>

  <div style="padding:14px 16px;color:#cfd8e3;">
    © <span id="year"></span>
  </div>
</aside>

<main class="content">

  <!-- HERO -->
  <section class="card" style="text-align:center; position: relative;">
    <img src="../saved_model_outputs/hybrid_outputs/hybrid.jpeg" alt="Hybrid Model" style="position: absolute; right: 20px; top: 18px; width: 300px; height: 260px; max-height: 1050px; border-radius: 8px; object-fit: contain; z-index: 1;">
    <h1 style="font-weight: bold; font-size: 2.2em; text-align: center;">Hybrid Model</h1>
    <p class="muted" style="font-size: 0.9em; text-align: center;">
      SARIMA + LSTM Residual Correction
    </p>
    <p class="muted" style="font-size: 0.85em; text-align: center; margin-top: 8px;">
      SARIMA provides a seasonal baseline and LSTM learns residual errors using a 24-hour window.<br>
      Final predictions combine SARIMA baseline + Predicted residuals. Evaluated overall and at peak-load (p90).
    </p>

    <div class="tabs">
      <a class="tab" href="model_sarima.html"><i class="bi bi-graph-up"></i> SARIMA</a>
      <a class="tab" href="model_lstm.html"><i class="bi bi-cpu"></i> LSTM</a>
      <a class="tab active" href="model_hybrid.html"><i class="bi bi-layers"></i> Hybrid</a>
      <a class="tab" href="model_ensemble.html"><i class="bi bi-diagram-2"></i> Ensemble</a>
    </div>

    <div class="pill-row">
      <a class="pill" href="../saved_model_outputs/hybrid_outputs/metrics_hybrid.json" target="_blank" rel="noopener">
        <i class="bi bi-braces"></i> Metrics JSON
      </a>
      <a class="pill" href="../saved_model_outputs/hybrid_outputs/hybrid_predictions.csv" target="_blank" rel="noopener">
        <i class="bi bi-table"></i> Predictions CSV
      </a>
      <a class="pill" href="https://github.com/Mech123/dswp_group2/tree/main/scripts/models" target="_blank" rel="noopener">
        <i class="bi bi-journal-code"></i> Notebook
      </a>
    </div>

    <!-- KPIs computed from CSV -->
    <div class="kpi-grid" id="csvKpis" style="display:none;">
      <div class="kpi"><p class="label">Overall MAE</p><p class="value" id="kpiMaeAll">–</p></div>
      <div class="kpi"><p class="label">Overall RMSE</p><p class="value" id="kpiRmseAll">–</p></div>
      <div class="kpi"><p class="label">Peak MAE</p><p class="value" id="kpiMaePeak">–</p></div>
      <div class="kpi"><p class="label">Peak RMSE</p><p class="value" id="kpiRmsePeak">–</p></div>
    </div>

    <div id="csvState" class="muted" style="margin-top:10px;">Loading CSV metrics…</div>
  </section>

  <div class="dash">

    <!-- LEFT: Metrics + Figures -->
    <section class="card" style="text-align: center;">
      <h2 style="font-weight: bold; font-size: 1.5em;">Metrics & Visualizations</h2>
      <p class="muted">Click an image to zoom. Navigate between images using arrow buttons or keyboard.</p>

      <div class="grid" style="margin-top: 20px;">

        <!-- Training History -->
        <div class="cardplot"
             data-group="training"
             data-title="Training History"
             data-cap="Hybrid residual LSTM training history showing convergence and stability.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Training History</div>
              <div class="cardplot-sub">Residual LSTM convergence and validation metrics</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/training_history_hybrid.png"
                 alt="Training history"
                 data-modal="true"
                 data-caption="Hybrid residual LSTM training history showing convergence and stability while learning residual corrections."/>
          </div>
        </div>

        <!-- Predictions Visualization -->
        <div class="cardplot"
             data-group="predictions"
             data-title="Actual vs Predicted"
             data-cap="Hybrid model predictions compared to actual demand across test horizon.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Actual vs Predicted</div>
              <div class="cardplot-sub">Baseline + Residual correction behavior</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/predictions_visualization_hybrid.png"
                 alt="Predictions visualization"
                 data-modal="true"
                 data-caption="Hybrid actual vs predicted visualization showing baseline + residual correction behavior across the test horizon."/>
          </div>
        </div>

        <!-- Peak PR Curve -->
        <div class="cardplot"
             data-group="peak"
             data-title="Peak Detection PR Curve"
             data-cap="Precision-Recall tradeoff for peak-load detection comparing SARIMA vs Hybrid.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Peak Detection PR Curve</div>
              <div class="cardplot-sub">Precision-Recall analysis for peak-load detection</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/peak_pr_curve.png"
                 alt="Peak PR Curve"
                 data-modal="true"
                 data-caption="Peak Detection Precision-Recall Curve comparing SARIMA and Hybrid models for peak-load detection (p90 threshold)."/>
          </div>
        </div>

        <!-- Data Split Visualization -->
        <div class="cardplot"
             data-group="data-split"
             data-title="Train/Validation/Test Data Split"
             data-cap="Full time series with train/val/test splits and zoomed view showing chronological partitioning.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Data Split Visualization</div>
              <div class="cardplot-sub">Train/Val/Test chronological partitioning</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/01_data_split_visualization.png"
                 alt="Data split visualization"
                 data-modal="true"
                 data-caption="Train/Validation/Test data split showing full time series and zoomed view with chronological partitioning."/>
          </div>
        </div>

        <!-- SARIMA Diagnostics -->
        <div class="cardplot"
             data-group="diagnostics"
             data-title="SARIMA Diagnostics"
             data-cap="SARIMA fitted values vs actual (training) and forecast vs actual (test) with residuals distribution.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">SARIMA Diagnostics</div>
              <div class="cardplot-sub">Fitted values, forecasts, and residuals analysis</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/02_sarima_diagnostics.png"
                 alt="SARIMA diagnostics"
                 data-modal="true"
                 data-caption="SARIMA diagnostics: fitted values on training data, forecasts on test data, and residuals distribution showing systematic underprediction."/>
          </div>
        </div>

        <!-- Residual Analysis -->
        <div class="cardplot"
             data-group="diagnostics"
             data-title="Residual Analysis"
             data-cap="Residual targets and feature scaling visualization for LSTM residual correction model.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Residual Analysis</div>
              <div class="cardplot-sub">Residual targets and feature scaling</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/03_residual_analysis.png"
                 alt="Residual analysis"
                 data-modal="true"
                 data-caption="Residual analysis: visualization of residual targets and feature scaling for the LSTM residual correction component."/>
          </div>
        </div>

        <!-- Performance Comparison -->
        <div class="cardplot"
             data-group="performance"
             data-title="Performance Comparison: SARIMA vs Hybrid"
             data-cap="Overall and peak load performance comparison with error distribution analysis.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Performance Comparison</div>
              <div class="cardplot-sub">SARIMA vs Hybrid overall and peak performance</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/04_performance_comparison.png"
                 alt="Performance comparison"
                 data-modal="true"
                 data-caption="Performance comparison: SARIMA vs Hybrid showing overall metrics, peak load metrics, and error distributions."/>
          </div>
        </div>

        <!-- Prediction Summary -->
        <div class="cardplot"
             data-group="predictions"
             data-title="Prediction Summary Statistics"
             data-cap="Distribution, box plot, summary statistics, and residuals vs predicted values comparison.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Prediction Summary</div>
              <div class="cardplot-sub">Distribution, statistics, and residual analysis</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/05_prediction_summary.png"
                 alt="Prediction summary"
                 data-modal="true"
                 data-caption="Prediction summary: distribution comparison, box plots, summary statistics, and residuals vs predicted values showing systematic underprediction."/>
          </div>
        </div>

        <!-- Comprehensive Metrics -->
        <div class="cardplot"
             data-group="performance"
             data-title="Comprehensive Performance Metrics"
             data-cap="Hybrid model performance metrics including MAE, RMSE, MAPE, MASE, R², and directional accuracy.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Comprehensive Metrics</div>
              <div class="cardplot-sub">All performance metrics visualization</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/06_comprehensive_metrics.png"
                 alt="Comprehensive metrics"
                 data-modal="true"
                 data-caption="Comprehensive performance metrics: MAE, RMSE, MAPE, MASE, R², directional accuracy, and error distribution."/>
          </div>
        </div>

        <!-- Peak vs Non-Peak Analysis -->
        <div class="cardplot"
             data-group="peak"
             data-title="Peak vs Non-Peak Performance Analysis"
             data-cap="Peak load performance summary comparing MAE/RMSE, load distribution, and error distribution for peak vs non-peak periods.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Peak vs Non-Peak Analysis</div>
              <div class="cardplot-sub">Performance comparison during peak and normal periods</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/07_peak_vs_nonpeak_analysis.png"
                 alt="Peak vs non-peak analysis"
                 data-modal="true"
                 data-caption="Peak vs Non-Peak performance analysis: comparing metrics, load distribution, and error patterns for peak (p90+) and non-peak periods."/>
          </div>
        </div>

        <!-- Critical Peak Analysis -->
        <div class="cardplot"
             data-group="peak"
             data-title="Critical Peak Load Performance"
             data-cap="Critical peak predictions (Hour=10, Load≥p90) comparing SARIMA vs Hybrid with scatter plots, error distribution, and performance metrics.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Critical Peak Analysis</div>
              <div class="cardplot-sub">SARIMA vs Hybrid for critical peak loads</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/08_critical_peak_analysis.png"
                 alt="Critical peak analysis"
                 data-modal="true"
                 data-caption="Critical peak load performance: comparing SARIMA and Hybrid models for critical peaks (Hour=10, Load≥p90) with scatter plots, error distributions, and metrics."/>
          </div>
        </div>

        <!-- Time Series: Actual vs SARIMA vs Hybrid -->
        <div class="cardplot"
             data-group="predictions"
             data-title="Actual vs SARIMA vs Hybrid (30 Days)"
             data-cap="30-day aligned test window comparison showing actual load, SARIMA predictions, and Hybrid predictions with daily seasonality patterns.">
          <div class="cardplot-head">
            <div>
              <div class="cardplot-title">Time Series Comparison</div>
              <div class="cardplot-sub">Actual vs SARIMA vs Hybrid (30 days)</div>
            </div>
          </div>
          <div class="cardplot-body">
            <img class="plot-img"
                 src="../saved_model_outputs/hybrid_outputs/hybrid_timeseries_first30days.png"
                 alt="Time series comparison"
                 data-modal="true"
                 data-caption="Actual vs SARIMA vs Hybrid: 30-day aligned test window showing daily seasonality and model performance comparison."/>
          </div>
        </div>

      </div>

      <div class="grid-2" style="margin-top: 20px;">
        <div class="panel">
          <h3 style="margin:0 0 6px; font-weight: bold;">Model Summary</h3>
          <p class="muted" style="margin:0; font-size: 0.9em; text-align: left;">
            The Hybrid SARIMA + LSTM model improves directional reliability by learning residual errors on top of a strong seasonal baseline, while preserving SARIMA’s stability.However, the model shows high absolute error, indicating that while it tracks demand trends and peaks well, it struggles with precise magnitude calibration during volatile load periods
          </p>
          <div class="directional-accuracy-card" id="directionalAccuracyCard" style="display:none;">
            <div class="label">Directional Accuracy</div>
            <div class="value" id="directionalAccuracyValue">–</div>
          </div>
        </div>
        <div class="panel">
          <h3 style="margin:0 0 6px; font-weight: bold; font-size: 0.9em;">Computed Predictions</h3>
          <div class="metrics-grid" id="csvTable" style="display:none;">
            <div class="metrics-col">
              <div class="metrics-col-header">Overall</div>
              <table>
                <tbody id="csvBodyOverall"></tbody>
              </table>
            </div>
            <div class="metrics-col">
              <div class="metrics-col-header">Peak</div>
              <table>
                <tbody id="csvBodyPeak"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="hero-actions" style="justify-content:center; margin-top:20px;">
        <a class="btn" href="models.html"><i class="bi bi-arrow-left"></i>Models</a>
        <a class="btn primary" href="explainability.html"><i class="bi bi-arrow-right"></i> Explainability</a>
      </div>
    </section>

  </div>
</main>

<!-- Modal -->
<div class="modal-overlay" id="imgModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Plot viewer">
    <div class="modal-head">
      <div class="modal-title" id="modalTitle">Plot</div>
      <div class="modal-actions">
        <button class="icon-round" id="prevBtn" aria-label="Previous"><i class="bi bi-chevron-left"></i></button>
        <button class="icon-round" id="nextBtn" aria-label="Next"><i class="bi bi-chevron-right"></i></button>
        <button class="icon-round" id="closeBtn" aria-label="Close"><i class="bi bi-x-lg"></i></button>
      </div>
    </div>
    <div class="modal-body">
      <img id="modalImg" alt="Expanded plot">
      <div class="modal-cap" id="modalCap"></div>
    </div>
  </div>
</div>

<script>
  function toNum(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }
  function fmt(x, d=3){
    if (x === null || x === undefined) return "N/A";
    if (!Number.isFinite(x)) return "N/A";
    return x.toFixed(d);
  }
  function mae(y, yhat){ let s=0; for (let i=0;i<y.length;i++) s += Math.abs(y[i]-yhat[i]); return y.length ? s/y.length : null; }
  function rmse(y, yhat){ let s=0; for (let i=0;i<y.length;i++){ const e=y[i]-yhat[i]; s += e*e; } return y.length ? Math.sqrt(s/y.length) : null; }
  function mape(y, yhat){
    let s=0, c=0;
    for (let i=0;i<y.length;i++){
      const denom = Math.abs(y[i]);
      if (denom === 0) continue;
      s += Math.abs((y[i]-yhat[i]) / denom);
      c++;
    }
    return c ? (s/c)*100 : null;
  }
  function smape(y, yhat){
    let s=0, c=0;
    for (let i=0;i<y.length;i++){
      const denom = (Math.abs(y[i]) + Math.abs(yhat[i]));
      if (denom === 0) continue;
      s += (2*Math.abs(y[i]-yhat[i]) / denom);
      c++;
    }
    return c ? (s/c)*100 : null;
  }
  function r2(y, yhat){
    const n=y.length;
    if (!n) return null;
    const mean = y.reduce((a,b)=>a+b,0)/n;
    let ssRes=0, ssTot=0;
    for (let i=0;i<n;i++){
      const e=y[i]-yhat[i]; ssRes += e*e;
      const d=y[i]-mean; ssTot += d*d;
    }
    if (ssTot === 0) return null;
    return 1 - (ssRes/ssTot);
  }
  function directionalAccuracy(y, yhat){
    if (y.length < 2 || yhat.length < 2) return null;
    let correct = 0;
    let total = 0;
    for (let i=1; i<y.length; i++){
      const actualDir = y[i] - y[i-1];
      const predDir = yhat[i] - yhat[i-1];
      if ((actualDir > 0 && predDir > 0) || (actualDir < 0 && predDir < 0) || (actualDir === 0 && predDir === 0)){
        correct++;
      }
      total++;
    }
    return total > 0 ? (correct / total) * 100 : null;
  }

  async function loadJsonMetrics(){
    const state = document.getElementById("metricsState");
    const table = document.getElementById("metricsTable");
    const body = document.getElementById("metricsBody");

    try{
      const res = await fetch("../saved_model_outputs/hybrid_outputs/metrics_hybrid.json", { cache: "no-store" });
      if (!res.ok) throw new Error("json not found");
      const data = await res.json();

      const rows = [];
      Object.keys(data).forEach((k) => {
        const v = data[k];
        rows.push([k, (typeof v === "object") ? JSON.stringify(v) : String(v)]);
      });

      body.innerHTML = rows.map(([k, v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join("");
      state.style.display = "none";
      table.style.display = "table";
    }catch(e){
      state.textContent = "Could not load metrics_hybrid.json.";
    }
  }

  async function loadCsvMetrics(){
    const state = document.getElementById("csvState");
    const tbl = document.getElementById("csvTable");
    const body = document.getElementById("csvBody");
    const kpis = document.getElementById("csvKpis");

    try{
      const res = await fetch("../saved_model_outputs/hybrid_outputs/hybrid_predictions.csv", { cache: "no-store" });
      if (!res.ok) throw new Error("csv not found");
      const text = await res.text();

      const lines = text.trim().split(/\r?\n/);
      const header = lines[0].split(",").map(s => s.trim());
      const idxActual = header.indexOf("actual");
      const idxPred   = header.indexOf("predicted");
      const idxPeak   = header.indexOf("is_peak");

      if (idxActual < 0 || idxPred < 0) throw new Error("Missing actual/predicted columns");

      const yAll=[], yhatAll=[], yPeak=[], yhatPeak=[];
      for (let i=1;i<lines.length;i++){
        if (!lines[i].trim()) continue;
        const cols = lines[i].split(",");
        const a = toNum(cols[idxActual]);
        const p = toNum(cols[idxPred]);
        if (a === null || p === null) continue;

        yAll.push(a); yhatAll.push(p);

        let isPeak = false;
        if (idxPeak >= 0){
          const v = String(cols[idxPeak]).trim().toLowerCase();
          isPeak = (v === "1" || v === "true" || v === "yes");
        }
        if (isPeak){ yPeak.push(a); yhatPeak.push(p); }
      }

      const out = {
        "Overall MAE": mae(yAll, yhatAll),
        "Overall RMSE": rmse(yAll, yhatAll),
        "Overall MAPE (%)": mape(yAll, yhatAll),
        "Overall sMAPE (%)": smape(yAll, yhatAll),
        "Overall R²": r2(yAll, yhatAll),
        "Directional Accuracy": directionalAccuracy(yAll, yhatAll),
        "Peak MAE": yPeak.length ? mae(yPeak, yhatPeak) : null,
        "Peak RMSE": yPeak.length ? rmse(yPeak, yhatPeak) : null,
        "Peak MAPE (%)": yPeak.length ? mape(yPeak, yhatPeak) : null,
        "Peak sMAPE (%)": yPeak.length ? smape(yPeak, yhatPeak) : null,
        "Peak R²": yPeak.length ? r2(yPeak, yhatPeak) : null,
        "Rows used (overall)": yAll.length,
        "Rows used (peak)": yPeak.length
      };

      document.getElementById("kpiMaeAll").textContent  = fmt(out["Overall MAE"]);
      document.getElementById("kpiRmseAll").textContent = fmt(out["Overall RMSE"]);
      document.getElementById("kpiMaePeak").textContent = fmt(out["Peak MAE"]);
      document.getElementById("kpiRmsePeak").textContent= fmt(out["Peak RMSE"]);

      // Display Directional Accuracy in summary card
      const dirAcc = out["Directional Accuracy"];
      if (dirAcc !== null && dirAcc !== undefined) {
        document.getElementById("directionalAccuracyValue").textContent = fmt(dirAcc, 2) + "%";
        document.getElementById("directionalAccuracyCard").style.display = "block";
      }

      // Overall metrics
      const overallOrder = [
        "Overall MAE",
        "Overall RMSE",
        "Overall MAPE (%)",
        "Overall sMAPE (%)",
        "Overall R²"
      ];
      const overallBody = document.getElementById("csvBodyOverall");
      overallBody.innerHTML = overallOrder.map((k) => {
        const v = out[k];
        const show = (typeof v === "number") ? (Number.isInteger(v) ? String(v) : fmt(v)) : "N/A";
        const metricName = k.replace("Overall ", "");
        const isBold = metricName.includes("MAE") || metricName.includes("RMSE") || metricName.includes("R²");
        const valueCell = isBold ? `<td style="font-weight: bold;">${show}</td>` : `<td>${show}</td>`;
        return `<tr><td>${metricName}</td>${valueCell}</tr>`;
      }).join("");

      // Peak metrics
      const peakOrder = [
        "Peak MAE",
        "Peak RMSE",
        "Peak MAPE (%)",
        "Peak sMAPE (%)",
        "Peak R²"
      ];
      const peakBody = document.getElementById("csvBodyPeak");
      peakBody.innerHTML = peakOrder.map((k) => {
        const v = out[k];
        const show = (typeof v === "number") ? (Number.isInteger(v) ? String(v) : fmt(v)) : "N/A";
        const metricName = k.replace("Peak ", "");
        const isBold = metricName.includes("MAE") || metricName.includes("RMSE") || metricName.includes("R²");
        const valueCell = isBold ? `<td style="font-weight: bold;">${show}</td>` : `<td>${show}</td>`;
        return `<tr><td>${metricName}</td>${valueCell}</tr>`;
      }).join("");

      state.style.display = "none";
      kpis.style.display = "grid";
      tbl.style.display = "grid";
    }catch(e){
      state.textContent = "Could not compute Hybrid metrics from CSV.";
    }
  }

  // Modal setup with navigation
  const modal = document.getElementById('imgModal');
  const modalImg = document.getElementById('modalImg');
  const modalTitle = document.getElementById('modalTitle');
  const modalCap = document.getElementById('modalCap');
  const closeBtn = document.getElementById('closeBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  let visibleCards = [];
  let currentIndex = 0;

  function refreshVisibleCards(){
    visibleCards = Array.from(document.querySelectorAll('.cardplot'));
  }

  function openModalByIndex(i){
    refreshVisibleCards();
    currentIndex = Math.max(0, Math.min(i, visibleCards.length - 1));
    const c = visibleCards[currentIndex];
    const img = c.querySelector('img[data-modal="true"]');
    if (img) {
      modalImg.src = img.getAttribute('src');
      modalTitle.textContent = c.dataset.title || 'Plot';
      modalCap.textContent = img.getAttribute('data-caption') || c.dataset.cap || '';
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }
  }
  function closeModal(){
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
    modalImg.src = '';
  }
  function nextImg(){ 
    refreshVisibleCards();
    if (visibleCards.length > 0) {
      openModalByIndex((currentIndex + 1) % visibleCards.length); 
    }
  }
  function prevImg(){ 
    refreshVisibleCards();
    if (visibleCards.length > 0) {
      openModalByIndex((currentIndex - 1 + visibleCards.length) % visibleCards.length); 
    }
  }

  document.querySelectorAll('.cardplot img[data-modal="true"]').forEach((img, idx) => {
    img.style.cursor = "zoom-in";
    img.addEventListener('click', (e) => {
      e.stopPropagation();
      const card = img.closest('.cardplot');
      const cardIndex = Array.from(document.querySelectorAll('.cardplot')).indexOf(card);
      openModalByIndex(cardIndex);
    });
  });

  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (nextBtn) nextBtn.addEventListener('click', nextImg);
  if (prevBtn) prevBtn.addEventListener('click', prevImg);
  if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

  document.addEventListener('keydown', (e) => {
    if (!modal || !modal.classList.contains('open')) return;
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowRight') nextImg();
    if (e.key === 'ArrowLeft') prevImg();
  });

  loadJsonMetrics();
  loadCsvMetrics();
</script>

<script src="../assets/app.js"></script>
</body>
</html>
